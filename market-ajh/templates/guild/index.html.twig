{% extends 'base.html.twig' %}

{% block title %}Hello GuildController!{% endblock %}

{% block body %}
    <h1>Gestion des Chefs de Guilde</h1>

    <form method="get">
        <label for="user-search">Rechercher un utilisateur :</label>
        <input type="text" id="user-search" name="user_search" value="{{ app.request.get('user_search') }}">
        <button type="submit">Rechercher</button>
    </form>

    {% if app.request.get('user_search') is not empty %}
        <h2>Résultats de la recherche :</h2>
        <ul>
            {% set found = false %}
            {% for user in users %}
                {% if user.username matches('/' ~ app.request.get('user_search')|e('js') ~ '/i') %}
                    {% set found = true %}
                    <li>
                        <strong>Nom d'utilisateur :</strong> {{ user.username }}<br>
                        <strong>Guilde :</strong> {{ user.guild ? user.guild.name : 'Aucune' }}<br>
                        <strong>Chef de la guilde :</strong> {{ user.chiefOf ? user.chiefOf.name : 'Non' }}
                        <form method="post" class="assign-chief-form" data-user-id="{{ user.id }}" action="#">
                        
                            <select name="guild_id" class="guild-selector">
                                {% for guild in guilds %}
                                    <option value="{{ guild.id }}">{{ guild.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit">Assigner comme chef</button>
                        </form>
                    </li>
                {% endif %}
            {% endfor %}
            {% if not found %}
                <li>Aucun utilisateur trouvé.</li>
            {% endif %}
        </ul>
    {% endif %}

    <h2>Liste des Guildes et leurs Chefs</h2>
    <table>
        <thead>
            <tr>
                <th>Guilde</th>
                <th>Chef</th>
            </tr>
        </thead>
        <tbody>
            {% for guild in guilds %}
                <tr>
                    <td>{{ guild.name }}</td>
                    <td>
                        {% if guild.chef %}
                            {{ guild.chef.username }}
                        {% else %}
                            <em>Pas de chef assigné</em>
                        {% endif %}
                    </td>
                    <td>
                        <form method="post" action="{{ path('guild_delete', {'id': guild.id}) }}" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cette guilde ?');">
                            <button type="submit" class="btn btn-danger">Supprimer</button>
                        </form>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    <script>
document.querySelectorAll('.assign-chief-form').forEach(form => {
    const select = form.querySelector('.guild-selector');
    const userId = form.dataset.userId;

    form.addEventListener('submit', function (e) {
        e.preventDefault(); // empêcher l'envoi immédiat

        const guildId = select.value;
        const newAction = `/assign-chief/${guildId}/${userId}`;
        form.action = newAction;
        form.submit(); // soumettre avec la bonne URL
    });
});
</script>
{% for label, messages in app.flashes %}
    {% for message in messages %}
        <div class="flash-{{ label }}">{{ message }}</div>
    {% endfor %}
{% endfor %}
<form method="post" action="{{ path('guild_create') }}">
    <label for="guild-name">Nom de la guilde :</label>
    <input type="text" id="guild-name" name="name" required>
    <label for="allowedtosell">
        <input type="checkbox" id="allowedtosell" name="allowedtosell" value="true">
    </label>
    <small>Cocher cette case pour indiquer que la guilde est commerçante.</small>
    <br>
    <button type="submit">Créer la guilde</button>
</form>

{% endblock %}
