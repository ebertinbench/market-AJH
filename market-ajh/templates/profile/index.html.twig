{% extends 'base.html.twig' %}
{% block body %}
    <div class="container mx-auto mt-8 max-w-2xl bg-GREEN rounded shadow p-8">
   
        <form method="post" action="{{ path('profile_change_password') }}" class="mb-8">
            <div class="mb-4">
                <label for="newPassword" class="block text-BLACK font-semibold mb-2">Nouveau mot de passe</label>
                <input type="password" class="form-input w-full border border-gray-300 bg-WHITE rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-BLUE" id="newPassword" name="newPassword" required>
            </div>
            <button type="submit" class="bg-VIOLET text-WHITE px-4 py-2 rounded hover:bg-blue-700 transition">Changer le mot de passe</button>
        </form>

        <hr class="my-6">

        {% if user.guild %}
            <p class="mb-2"><strong>Mon pseudo :</strong> {{ user.username }}</p>
            <p class="mb-2"><strong>Nom de la guilde :</strong> <span class="text-BLUE">{{ user.guild.name }}</span></p>

            {% if user.guild.chef == user %}
                <p class="mb-4"><strong>Chef de la guilde :</strong> <span class="text-BLUE">{{ user.guild.chef.username }}</span></p>
                
                <!-- Grille pour les boutons de guilde -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <form action="{{ path('profile_add_members') }}" method="get">
                        <button type="submit" class="w-full bg-VIOLET text-WHITE px-4 py-2 rounded hover:bg-purple-700 transition">Ajouter des membres</button>
                    </form>
                    {% if user.guild.allowedToSell %}
                        <form action="{{ path('app_guild_items_index') }}" method="get">
                            <button type="submit" class="w-full bg-VIOLET text-WHITE px-4 py-2 rounded hover:bg-purple-700 transition">Gérer les items vendus</button>
                        </form>
                    {% else %}
                        <div></div> <!-- Élément vide pour maintenir la grille -->
                    {% endif %}
                </div>
            {% else %}
                <p class="mb-4"><strong>Chef de la guilde :</strong> <span class="text-BLUE">{{ user.guild.chef.username }}</span></p>
            {% endif %}
            <div class="flex justify-center mb-4">
                <form action="{{ path('guild_quit') }}" method="post" onsubmit="return confirm('Es-tu sûr de vouloir quitter la guilde ?');">
                    <button type="submit" class="bg-VIOLET text-WHITE px-4 py-2 rounded">Quitter la guilde</button>
                </form>
            </div>
        {% else %}
            <p class="mb-4 text-WHITE">Vous n'appartenez à aucune guilde.</p>
        {% endif %}

        <hr class="my-6">

        <!-- Grille pour les boutons de profil -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
            <button onclick="openDiscordModal()" class="bg-VIOLET text-WHITE px-4 py-2 rounded hover:bg-purple-700 transition">
                Modifier pseudo Discord
            </button>

            <button onclick="openMinecraftModal()" class="bg-VIOLET text-WHITE px-4 py-2 rounded hover:bg-purple-700 transition">
                Modifier pseudo Minecraft
            </button>

            <button onclick="openWallpaperModal()" class="bg-VIOLET text-WHITE px-4 py-2 rounded hover:bg-purple-700 transition">
                Changer le fond d'écran
            </button>
        </div>

        <div class="flex justify-center">
            <form method="post" action="{{ path('profile_delete_account') }}" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer votre compte ? Cette action est irréversible.');">
                <button type="submit" class="bg-VIOLET text-WHITE px-4 py-2 rounded ">Supprimer mon compte</button>
            </form>
        </div>

        <!-- Discord Modal -->
        <div id="discordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
            <div class="bg-GREEN rounded-lg p-6 w-96 max-w-lg mx-4">
                <h3 class="text-xl font-bold mb-4 text-WHITE">Modifier pseudo Discord</h3>
                <form method="post" action="{{ path('app_user_edit_discord', {'id': user.id}) }}">
                    <input type="hidden" name="_token" value="{{ csrf_token('edit_discord' ~ user.id) }}">
                    <div class="mb-4">
                        <label for="discordPseudo" class="block text-WHITE font-semibold mb-2">Nouveau pseudo Discord</label>
                        <input type="text" id="discordPseudo" name="discordPseudo" class="form-input w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-BLUE" value="{{ user.pseudoDiscord ?? '' }}" required>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="closeDiscordModal()" class="bg-gray-500 text-WHITE px-4 py-2 rounded hover:bg-gray-600 transition">
                            Annuler
                        </button>
                        <button type="submit" class="bg-VIOLET text-WHITE px-4 py-2 rounded hover:bg-purple-700 transition">
                            Sauvegarder
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Minecraft Modal -->
        <div id="minecraftModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
            <div class="bg-GREEN rounded-lg p-6 w-96 max-w-lg mx-4">
                <h3 class="text-xl font-bold mb-4 text-WHITE">Modifier pseudo Minecraft</h3>
                <form method="post" action="{{ path('app_user_edit_minecraft', {'id': user.id}) }}">
                    <input type="hidden" name="_token" value="{{ csrf_token('edit_minecraft' ~ user.id) }}">
                    <div class="mb-4">
                        <label for="minecraftPseudo" class="block text-WHITE font-semibold mb-2">Nouveau pseudo Minecraft</label>
                        <input type="text" id="minecraftPseudo" name="minecraftPseudo" class="form-input w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-BLUE" value="{{ user.pseudoMinecraft ?? '' }}" required>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="closeMinecraftModal()" class="bg-gray-500 text-WHITE px-4 py-2 rounded hover:bg-gray-600 transition">
                            Annuler
                        </button>
                        <button type="submit" class="bg-VIOLET text-WHITE px-4 py-2 rounded hover:bg-purple-700 transition">
                            Sauvegarder
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Wallpaper Modal -->
        <div id="wallpaperModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
            <div class="bg-GREEN rounded-lg p-6 w-4/5 max-w-4xl mx-4 max-h-5/6 overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-WHITE">Choisir un fond d'écran</h3>
            <form method="post" action="{{ path('app_user_change_wallpaper', {'id': user.id}) }}">
                <input type="hidden" name="_token" value="{{ csrf_token('change_wallpaper' ~ user.id) }}">
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-4">
                {% for wallpaper in wallpaperservice.getAllWallpapers() %}
                    <div class="relative cursor-pointer wallpaper-option" onclick="selectWallpaper('{{ wallpaper }}', this)">
                    <input type="radio" name="wallpaper" value="{{ wallpaper }}" class="hidden wallpaper-radio" id="wallpaper_{{ loop.index }}" {% if user.wallpaper == wallpaper %}checked{% endif %}>
                    <img src="{{ asset('images/wallpapers/' ~ wallpaper) }}" 
                         alt="{{ wallpaper }}" 
                         class="w-full h-24 object-cover rounded border-2 {% if user.wallpaper == wallpaper %}border-VIOLET{% else %}border-transparent{% endif %} wallpaper-img">
                    {% if user.wallpaper == wallpaper %}
                    <div class="absolute top-1 right-1 bg-VIOLET rounded-full w-6 h-6 flex items-center justify-center">
                        <span class="text-WHITE font-bold text-sm">✓</span>
                    </div>
                    {% endif %}
                    </div>
                {% endfor %}
                </div>
                <div class="flex justify-end space-x-2">
                <button type="button" onclick="closeWallpaperModal()" class="bg-gray-500 text-WHITE px-4 py-2 rounded hover:bg-gray-600 transition">
                    Annuler
                </button>
                <button type="submit" class="bg-VIOLET text-WHITE px-4 py-2 rounded hover:bg-purple-700 transition" {% if not user.wallpaper %}disabled{% endif %} id="wallpaperSubmitBtn">
                    Sauvegarder
                </button>
                </div>
            </form>
            </div>
        </div>

        <script>
        function openWallpaperModal() {
            document.getElementById('wallpaperModal').classList.remove('hidden');
        }

        function closeWallpaperModal() {
            document.getElementById('wallpaperModal').classList.add('hidden');
        }

        function selectWallpaper(wallpaperName, element) {
            // Remove selection from all options
            document.querySelectorAll('.wallpaper-option').forEach(option => {
            option.querySelector('.wallpaper-img').classList.remove('border-VIOLET');
            option.querySelector('.wallpaper-img').classList.add('border-transparent');
            const checkmark = option.querySelector('.absolute.top-1.right-1');
            if (checkmark) checkmark.remove();
            option.querySelector('.wallpaper-radio').checked = false;
            });
            
            // Add selection to clicked option
            element.querySelector('.wallpaper-img').classList.add('border-VIOLET');
            element.querySelector('.wallpaper-img').classList.remove('border-transparent');
            element.querySelector('.wallpaper-radio').checked = true;
            
            // Add checkmark
            const checkmark = document.createElement('div');
            checkmark.className = 'absolute top-1 right-1 bg-VIOLET rounded-full w-6 h-6 flex items-center justify-center';
            checkmark.innerHTML = '<span class="text-WHITE font-bold text-sm">✓</span>';
            element.appendChild(checkmark);
            
            // Enable submit button
            document.getElementById('wallpaperSubmitBtn').disabled = false;
        }

        // Close modal when clicking outside
        document.getElementById('wallpaperModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeWallpaperModal();
            }
        });
        </script>
        <script>
        function openDiscordModal() {
            document.getElementById('discordModal').classList.remove('hidden');
        }

        function closeDiscordModal() {
            document.getElementById('discordModal').classList.add('hidden');
        }

        function openMinecraftModal() {
            document.getElementById('minecraftModal').classList.remove('hidden');
        }

        function closeMinecraftModal() {
            document.getElementById('minecraftModal').classList.add('hidden');
        }

        // Close modals when clicking outside
        document.getElementById('discordModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDiscordModal();
            }
        });

        document.getElementById('minecraftModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeMinecraftModal();
            }
        });
        </script>
    </div>
<h3 class="text-xl font-bold mt-8 mb-4 text-center text-WHITE">Mes commandes</h3>
{% if commandes is not empty %}
    <div class="overflow-x-auto w-full">
        <table class="min-w-full rounded shadow">
            <thead>
                <tr class="bg-BLACK text-WHITE">
                    <th class="py-2 px-4 text-left">Item</th>
                    <th class="py-2 px-4 text-left">Statut</th>
                    <th class="py-2 px-4 text-left">Date de commande</th>
                    <th class="py-2 px-4 text-left">Vendeur</th>
                    <th class="py-2 px-4 text-left">Prix unitaire</th>
                    <th class="py-2 px-4 text-left">Quantité</th>
                    <th class="py-2 px-4 text-left">Total</th>
                    <th class="py-2 px-4 text-left">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for commande in commandes %}
                    <tr class="border-b bg-GREEN text-BLACK">
                        <td class="py-2 px-4">{{ commande.idItem.item.nom }}</td>
                        <td class="py-2 px-4">{{ commande.statut }}</td>
                        <td class="py-2 px-4">{{ commande.dateCommande ? commande.dateCommande|date('d/m/Y H:i') : '' }}</td>
                        <td class="py-2 px-4">{{ commande.idVendeur ? commande.idVendeur.username : 'Non assigné' }}</td>
                        <td class="py-2 px-4">{{ commande.total / commande.quantite }}</td>
                        <td class="py-2 px-4">{{ commande.quantite }}</td>
                        <td class="py-2 px-4">{{ commande.getTotal() }}</td>
                        {% if commande.statut == 'En attente de livraison' %}
                            <td class="py-2 px-4">
                                <form action="{{ path('orders_mark_delivered', { id: commande.id }) }}" method="post">
                                    <button type="submit" class="bg-VIOLET text-white px-4 py-2 rounded">Marquer comme livrée</button>
                                </form>
                            </td>
                        {% elseif commande.statut == 'Livrée'  and commande.avisCommande is empty %}
                            <td class="py-2 px-4">
                                <form action="{{ path('orders_give_advice', { id: commande.id }) }}" method="post" class="inline">
                                    <select name="note" required class="border border-gray-300 rounded px-2 py-1 mr-2">
                                        <option value="">Note</option>
                                        <option value="1">1/5</option>
                                        <option value="2">2/5</option>
                                        <option value="3">3/5</option>
                                        <option value="4">4/5</option>
                                        <option value="5">5/5</option>
                                    </select>
                                    <button type="submit" class="bg-VIOLET text-white px-4 py-2 rounded">Donner un avis</button>
                                </form>
                            </td>
                        {% else %}
                            <td class="py-2 px-4">Aucune action disponible</td>
                        {% endif %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <p class="text-WHITE text-center">Aucune commande passée.</p>
{% endif %}
{% endblock %}